name: Clang Format Check

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.cc'
      - '**/*.cxx'
      - '**/*.java'
      - '**/*.js'
      - '**/*.json'
      - '**/*.m'
      - '**/*.h'
      - '**/*.proto'
      - '**/*.cs'

jobs:
  clang-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensures the full history is fetched for PR diff

      - name: Install clang-format
        run: sudo apt-get install -y clang-format

      - name: Fetch base branch and check for clang-format
        run: |
          git fetch origin main:main
          if [ $? -ne 0 ]; then
            echo "Failed to fetch the 'main' branch from origin."
            exit 1
          fi

          # Run git-clang-format and store the output
          output=$(git-clang-format origin/main --diff)
          echo "$output"

          if ! echo "$output" | grep -q "no modified files to format"; then
            echo "Formatting issues detected. Below are the required changes:"
            echo "$output"  # Print the diff for contributors
            echo "To resolve these issues, run the following command locally:"
            echo "  git-clang-format origin/main"
            echo "After fixing the formatting, commit and push the changes."
            exit 1  # Fail the workflow to enforce formatting
          fi



